#!/bin/bash

# –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ FreePBX —á–µ—Ä–µ–∑ UFW –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ó–∞—â–∏—Ç–∞ –æ—Ç CVE-2024-45602
# –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ FreePBX: ssh root@37.27.240.184

set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[$(date +'%H:%M:%S')] $1${NC}"; }
warn() { echo -e "${YELLOW}[WARNING] $1${NC}"; }
error() { echo -e "${RED}[ERROR] $1${NC}"; exit 1; }

# –í–∞—à –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π IP –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
TRUSTED_IP="162.120.187.223"

echo "üî• –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ó–ê–©–ò–¢–ê FreePBX –æ—Ç CVE-2024-45602"
echo "üõ°Ô∏è  –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Ç–æ–ª—å–∫–æ –¥–ª—è $TRUSTED_IP"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ UFW
if ! command -v ufw &> /dev/null; then
    error "UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: apt install ufw"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
log "–¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ UFW:"
ufw status numbered

echo ""
warn "–í–ù–ò–ú–ê–ù–ò–ï: –°–µ–π—á–∞—Å –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É FreePBX!"
warn "–î–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–º 8080/8443 –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —Å IP: $TRUSTED_IP"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 0
fi

log "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤–µ–±-–ø–æ—Ä—Ç–æ–≤..."
# –£–¥–∞–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤–µ–±-–ø–æ—Ä—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
ufw delete allow 8080/tcp 2>/dev/null || true
ufw delete allow 8443/tcp 2>/dev/null || true

log "–î–æ–±–∞–≤–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è $TRUSTED_IP..."
# –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Ç–æ–ª—å–∫–æ —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ IP
ufw allow from $TRUSTED_IP to any port 8080 proto tcp comment "FreePBX Web - Trusted IP only"
ufw allow from $TRUSTED_IP to any port 8443 proto tcp comment "FreePBX HTTPS - Trusted IP only"

log "–ü—Ä–æ–≤–µ—Ä—è–µ–º SIP –ø–æ—Ä—Ç—ã (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –≤—Å–µ—Ö)..."
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ SIP –ø–æ—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –≤—Å–µ—Ö
if ! ufw status | grep -q "5060.*ALLOW.*Anywhere"; then
    warn "–î–æ–±–∞–≤–ª—è–µ–º SIP –ø–æ—Ä—Ç—ã..."
    ufw allow 5060/udp comment "SIP UDP"
    ufw allow 5060/tcp comment "SIP TCP" 
    ufw allow 5160/udp comment "PJSIP UDP"
    ufw allow 5160/tcp comment "PJSIP TCP"
    ufw allow 10000:20000/udp comment "RTP Media"
fi

log "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º UFW..."
ufw reload

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
log "–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ UFW:"
ufw status numbered

echo ""
echo "=============================================="
log "üîí –ó–∞—â–∏—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "=============================================="
echo ""
echo "‚úÖ –ó–ê–©–ò–©–ï–ù–û:"
echo "   ‚Ä¢ FreePBX Web (8080) - –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Å $TRUSTED_IP"
echo "   ‚Ä¢ FreePBX HTTPS (8443) - –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Å $TRUSTED_IP"
echo ""
echo "‚úÖ –û–¢–ö–†–´–¢–û –¥–ª—è –≤—Å–µ—Ö (–Ω—É–∂–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏):"
echo "   ‚Ä¢ SIP –ø–æ—Ä—Ç—ã (5060 UDP/TCP, 5160 UDP/TCP)"
echo "   ‚Ä¢ RTP –º–µ–¥–∏–∞ –ø–æ—Ä—Ç—ã (10000-20000 UDP)"
echo ""
warn "‚ö†Ô∏è  –ü–†–û–í–ï–†–¨–¢–ï:"
echo "1. –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –≤–∞—à–µ–≥–æ IP: http://37.27.240.184:8080"
echo "2. SIP —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤"
echo "3. –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –º–µ–∂–¥—É –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏"
echo ""
echo "üÜò –û–¢–ö–ê–¢ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):"
echo "   ufw allow 8080/tcp && ufw allow 8443/tcp && ufw reload"
echo "=============================================="